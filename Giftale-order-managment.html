<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Order Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for better look */
        .status-column {
            max-height: 80vh; /* Adjust based on viewport */
            overflow-y: auto;
        }
        .status-column::-webkit-scrollbar {
            width: 6px;
        }
        .status-column::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* Style for dragged item (visual feedback) */
        .opacity-50 {
            opacity: 0.5;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow-md rounded-xl p-4 mb-6 sticky top-0 z-10">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-700 mb-4 sm:mb-0">
                    Order Manager
                </h1>
                <div class="flex space-x-2">
                    <button id="show-form-btn" class="px-4 py-2 text-sm font-medium rounded-lg transition" 
                            onclick="switchView('form')">
                        Customer Form
                    </button>
                    <button id="show-initial-review-btn" class="px-4 py-2 text-sm font-medium rounded-lg transition" 
                            onclick="switchView('initial-review')">
                        Initial Review
                        <span id="initial-count" class="ml-1 px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full hidden">0</span>
                    </button>
                    <button id="show-dashboard-btn" class="px-4 py-2 text-sm font-medium rounded-lg transition" 
                            onclick="switchView('dashboard')">
                        Manager Dashboard
                    </button>
                </div>
            </div>
            <p id="auth-status" class="mt-2 text-xs text-gray-500"></p>
        </header>

        <div id="loading-screen" class="flex justify-center items-center h-64 text-gray-500">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading Application...
        </div>

        <section id="form-view" class="view hidden bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">New Order Submission (Updated Form)</h2>
            <form id="order-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="phone" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Shipping Address (House/Street)</label>
                    <input type="text" id="address" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="altPhone" class="block text-sm font-medium text-gray-700">Alternative Phone Number and Landmark</label>
                    <input type="text" id="altPhone" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 9876543210 near Main Market">
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="city" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">Pincode</label>
                        <input type="text" id="pincode" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                        <select id="state" required 
                                class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                            <option value="" disabled selected>-- Select State/UT --</option>
                            </select>
                    </div>
                </div>
                <div>
                    <label for="orderDetails" class="block text-sm font-medium text-gray-700">Order Details / Items</label>
                    <textarea id="orderDetails" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label for="comments" class="block text-sm font-medium text-gray-700">Comments / Notes</label>
                    <textarea id="comments" rows="2" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg shadow-md hover:bg-green-600 transition duration-150 font-semibold">
                    Submit Order
                </button>
            </form>
            <p id="form-message" class="mt-4 text-center hidden"></p>
        </section>

        <section id="initial-review-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Initial Review: New Submissions</h2>
            <p class="text-gray-600 mb-6">These orders are awaiting initial verification and review before moving to the main pipeline. **You can drag these cards to the 'Pending' column on the Manager Dashboard.**</p>
            <div id="initial-orders-list" class="space-y-4">
                </div>
            <p id="initial-empty-message" class="text-center text-gray-500 mt-10 hidden">üéâ No new orders in the queue! Time to review the dashboard.</p>
        </section>

        <section id="dashboard-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Order Status Board</h2>
            
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-start sm:items-center bg-white p-4 rounded-xl shadow-inner mb-6">
                <label for="status-select" class="text-sm font-medium text-gray-700 whitespace-nowrap">Export Orders with Status:</label>
                <select id="status-select" class="block w-full sm:w-auto border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="All">All Kanban Orders</option>
                    </select>
                <button onclick="downloadOrders()" class="w-full sm:w-auto px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition duration-150 shadow-md flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download CSV
                </button>
            </div>
            
            <div id="orders-kanban" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </section>

        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 transition-opacity duration-300 items-center justify-center">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-95">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800 mb-3"></h3>
                <div id="modal-content" class="text-gray-600 mb-5"></div>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition hidden">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Array containing Indian States and the remaining Union Territories
        const indianStatesAndUTs = [
            "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal",
            // Remaining Union Territories (UTs removed: Andaman, Dadra, Lakshadweep, Ladakh)
            "Chandigarh (UT)", 
            "Delhi (NCT)", 
            "Jammu and Kashmir (UT)", 
            "Puducherry (UT)"
        ];

        // ====================================================================
        // START: FIREBASE CONFIGURATION INJECTION
        // --------------------------------------------------------------------
        //
        //  THIS IS THE SPOT. 
        //  PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE.
        //  THIS IS SAFE TO DO.
        //
        const userFirebaseConfig = {
            apiKey: "AIzaSyDvOwo-7PfHNQZQyK9vZdQhDbs810-gOIc",
            authDomain: "giftale.firebaseapp.com",
            projectId: "giftale",
            storageBucket: "giftale.firebasestorage.app",
            messagingSenderId: "263266463361",
            appId: "1:263266463361:web:12966b4b1cb7d97cfe2780"
        };
        
        // =================================S===================================
        // END: FIREBASE CONFIGURATION INJECTION
        // ====================================================================


        // --- FIREBASE GLOBAL VARIABLES (DO NOT MODIFY BELOW THIS LINE) ---
        // The app checks for environment injection first, then falls back to the hardcoded config.
        const appId = typeof __app_id !== 'undefined' ? __app_id : userFirebaseConfig.projectId;
        
        let firebaseConfig = userFirebaseConfig;
        
        // If the environment successfully injects a config, use it instead of the hardcoded one.
        if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '' && __firebase_config.trim() !== '{}') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Error parsing injected Firebase config, using hardcoded fallback.");
            }
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // The check for DUMMY keys is no longer needed since we have real keys
        const IS_OFFLINE_MODE = false;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let ordersCollectionRef;
        let currentKanbanOrders = []; 

        // --- STATUS CONSTANTS ---
        const INITIAL_STATUS = 'FormFilled'; 
        const KANBAN_STATUSES = ['Pending', 'ToDo', 'Processing', 'Dispatched'];
        
        const STATUS_COLORS = {
            [INITIAL_STATUS]: 'bg-red-100 text-red-800',
            'Pending': 'bg-yellow-100 text-yellow-800',
            'ToDo': 'bg-indigo-100 text-indigo-800',
            'Processing': 'bg-blue-100 text-blue-800', 
            'Dispatched': 'bg-green-100 text-green-800',
        };
        
        const STATUS_LABELS = {
            [INITIAL_STATUS]: 'New Submission',
            'Pending': 'Pending',
            'ToDo': 'TO-DO',
            'Processing': 'Done', 
            'Dispatched': 'Shipped/Dispatched',
        };
        
        // --- Gemini API Configuration ---
        
        // ‚ö†Ô∏è DANGER: DO NOT PASTE YOUR SECRET GEMINI API KEY HERE! ‚ö†Ô∏è
        // This key will be stolen. You must use a Cloud Function.
        const apiKey = ""; 
        
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;


        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const formView = document.getElementById('form-view');
        const initialReviewView = document.getElementById('initial-review-view');
        const dashboardView = document.getElementById('dashboard-view');
        const orderForm = document.getElementById('order-form');
        const formMessage = document.getElementById('form-message');
        const ordersKanban = document.getElementById('orders-kanban');
        const initialOrdersList = document.getElementById('initial-orders-list');
        const initialEmptyMessage = document.getElementById('initial-empty-message');
        const authStatusP = document.getElementById('auth-status');
        const showFormBtn = document.getElementById('show-form-btn');
        const showInitialReviewBtn = document.getElementById('show-initial-review-btn');
        const initialCountSpan = document.getElementById('initial-count'); 
        const showDashboardBtn = document.getElementById('show-dashboard-btn');
        
        // --- Utility Functions ---

        // Custom Modal Implementation (for simple alerts/loading)
        function showModal(title, content, type = 'info') {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = `<p class="text-gray-600 mb-5">${content}</p>`; 
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            confirmBtn.textContent = 'OK';
            confirmBtn.onclick = () => { modal.classList.add('hidden'); };
            cancelBtn.classList.add('hidden');
            
            modal.classList.remove('hidden');
            modal.style.opacity = '0';
            setTimeout(() => { modal.style.opacity = '1'; modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }

        // Dedicated Modal for Gemini Drafts (allows copy/paste)
        function showDraftModal(title, content) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            
            modalTitle.textContent = title;
            
            // Inject the content into the modal body with a textarea for easy copying
            modalContent.innerHTML = `
                <p class="mb-3 text-sm font-semibold">AI Draft:</p>
                <textarea id="draft-output" class="w-full h-32 p-3 text-sm border border-gray-300 rounded-lg resize-none focus:ring-indigo-500" readonly>${content}</textarea>
                <p id="copy-status" class="text-xs text-green-600 mt-2 hidden">Copied to clipboard!</p>
            `;

            confirmBtn.textContent = 'Copy & Close';
            confirmBtn.onclick = () => { 
                const draftTextarea = document.getElementById('draft-output');
                if (draftTextarea) {
                    draftTextarea.select();
                    document.execCommand('copy'); 
                    document.getElementById('copy-status').classList.remove('hidden');
                }
                setTimeout(() => { modal.classList.add('hidden'); }, 500);
            };
            cancelBtn.classList.add('hidden');
            
            modal.classList.remove('hidden');
            modal.style.opacity = '0';
            setTimeout(() => { modal.style.opacity = '1'; modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }

        // Function to call the Gemini API with exponential backoff
        async function generateGeminiContent(systemInstruction, userQuery) {
            // This function is NOT SAFE to run from the client-side with a real API key.
            // This entire function should be moved to a Cloud Function.
            if (!apiKey || apiKey === "") {
                 showModal("Feature Disabled", "The AI drafting feature is not configured securely. A backend (like a Cloud Function) is required.");
                 return "AI feature not configured.";
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            let delay = 1000; // 1 second
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        return text || "Failed to generate content: Empty response.";
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        console.warn(`Rate limit exceeded (429). Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        const errorData = await response.json();
                        console.error("API Error Response:", errorData);
                        return `API call failed: ${response.status} ${response.statusText}. See console for details.`;
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    return `Network error: ${error.message}`;
                }
            }
            return "Failed to generate content after multiple retries.";
        }

        async function draftCustomerMessage(order) {
            // Check for offline mode before proceeding
            if (IS_OFFLINE_MODE) {
                 showModal("Feature Disabled", "The AI drafting feature is disabled because the Firebase configuration is missing.");
                return;
            }

            // Show a temporary loading modal
            showModal("Generating Draft...", "The AI is crafting a message based on the order status. This may take a few seconds.");

            const statusLabel = STATUS_LABELS[order.status];
            
            // Define the System Instruction (Persona and Formatting)
            const systemPrompt = `You are a helpful virtual assistant for an Instagram e-commerce store. Your task is to draft a short, friendly, and professional update message for the customer suitable for a direct message (DM) on Instagram. The message must be concise and use a warm, conversational tone. Do not use markdown (like asterisks or bolding) in the final output.`;

            // Define the User Query (Context and Goal)
            const userQuery = `Draft a customer message for Order ID ${order.id.substring(0, 8)}. 
                Current status: ${statusLabel}. 
                Customer name: ${order.customerName}. 
                Order details: ${order.orderDetails}.
                The purpose of the message is to inform the customer about the current status and, if needed, ask for confirmation or confirmation details. 
                - If the status is '${STATUS_LABELS.Pending}', ask the customer to confirm the details and payment.
                - If the status is '${STATUS_LABELS.Processing}', inform them that the item is complete and will be shipped soon.
                - If the status is '${STATUS_LABELS.Dispatched}', provide a friendly shipping notification.
                - If the status is '${STATUS_LABELS.FormFilled}', acknowledge the submission and state that you will review it shortly.`;

            const draft = await generateGeminiContent(systemPrompt, userQuery);

            document.getElementById('custom-modal').classList.add('hidden'); // Close loading modal

            if (draft.startsWith('API call failed') || draft.startsWith('Network error') || draft.startsWith('AI feature not configured')) {
                showModal("Generation Failed", draft);
            } else {
                showDraftModal(`Draft for ${order.customerName}`, draft);
            }
        }


        // --- Firebase Initialization and Auth ---

        // Display a message if offline mode is active
        if (IS_OFFLINE_MODE) {
            console.warn('Using DUMMY Firebase config. Data persistence will not work.');
            loadingScreen.innerHTML = '<p class="text-lg text-red-600 font-semibold mb-4">Database Not Configured</p><p>Please replace the "YOUR_..." credentials in the code with your actual Firebase project configuration to enable saving and loading orders.</p>';
        } else {
            try {
                // setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
                
                // Use session persistence for a better manager experience
                setPersistence(auth, browserSessionPersistence).then(async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }).catch(e => {
                    console.error("Auth Persistence/Sign-in Error:", e);
                });

                // Populate the State Dropdown immediately after the app initializes
                populateStateDropdown();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingScreen.textContent = 'Error initializing application. Check console for details.';
            }
        }


        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                authStatusP.textContent = 'Logged in as: ' + currentUserId;
                isAuthReady = true;
                loadingScreen.classList.add('hidden');
                
                // Manager starts on the dashboard, but we want to check initial review first
                switchView('initial-review'); 
                
                // Start listening for orders once authenticated
                if (db && !IS_OFFLINE_MODE) {
                    listenForOrders();
                    populateStatusSelect(); 
                } else if (IS_OFFLINE_MODE) {
                    authStatusP.textContent += ' (Offline Mode)';
                }

            } else {
                currentUserId = 'anonymous';
                authStatusP.textContent = 'Anonymous session.';
                isAuthReady = true;
                loadingScreen.classList.add('hidden');
                
                // Customer always starts on the form
                switchView('form');
            }
        });
        
        // --- Dropdown Population Function ---
        function populateStateDropdown() {
            const dropdown = document.getElementById('state');
            if (dropdown) {
                // Clear the default option
                dropdown.innerHTML = '<option value="" disabled selected>-- Select State/UT --</option>';

                indianStatesAndUTs.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    dropdown.appendChild(option);
                });
            }
        }


        // --- View Switching ---

        // Helper to reset button styles
        function resetButtons() {
            [showFormBtn, showInitialReviewBtn, showDashboardBtn].forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
        }

        window.switchView = (viewName) => {
            if (!isAuthReady) return; 
            
            const allViews = document.querySelectorAll('.view');
            allViews.forEach(v => v.classList.add('hidden'));
            resetButtons();

            if (viewName === 'form') {
                formView.classList.remove('hidden');
                showFormBtn.classList.add('bg-indigo-600', 'text-white');
            } else if (viewName === 'initial-review') {
                initialReviewView.classList.remove('hidden');
                showInitialReviewBtn.classList.add('bg-indigo-600', 'text-white');
            } else if (viewName === 'dashboard') {
                dashboardView.classList.remove('hidden');
                showDashboardBtn.classList.add('bg-indigo-600', 'text-white');
            }
        };

        // --- Order Form Submission ---
        
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Check if we are in offline mode
            if (IS_OFFLINE_MODE) {
                showModal("Connection Error", "The database is not configured. Submission is disabled.");
                return;
            }
            
            if (!db) {
                showModal("Error", "Database connection failed. Please check the console.");
                return;
            }

            // Capture all required fields from the updated form
            const newOrder = {
                customerName: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                altPhone: document.getElementById('altPhone').value, 
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                pincode: document.getElementById('pincode').value,
                state: document.getElementById('state').value, 
                orderDetails: document.getElementById('orderDetails').value,
                comments: document.getElementById('comments').value,
                status: INITIAL_STATUS, 
                createdAt: serverTimestamp(),
                submittedByUserId: currentUserId,
            };

            try {
                await addDoc(ordersCollectionRef, newOrder);
                formMessage.textContent = 'Order submitted successfully! We will contact you soon.';
                formMessage.classList.remove('hidden', 'text-red-600');
                formMessage.classList.add('text-green-600');
                orderForm.reset();
                populateStateDropdown(); 
                setTimeout(() => formMessage.classList.add('hidden'), 5000);
            } catch (error) {
                console.error("Error submitting order: ", error);
                showModal("Submission Failed", "There was an error submitting the order. Check the console for details and ensure Firestore rules allow public write access.");
                formMessage.textContent = 'Submission failed. Please try again.';
                formMessage.classList.remove('hidden', 'text-green-600');
                formMessage.classList.add('text-red-600');
            }
        });

        // --- Drag and Drop Handlers ---
        
        let draggedOrderId = null; 

        function handleDragStart(e, orderId) {
            // Check for offline mode before allowing drag
            if (IS_OFFLINE_MODE) {
                e.preventDefault(); 
                showModal("Feature Disabled", "Order status updates are disabled in offline mode.");
                return;
            }
            draggedOrderId = orderId;
            e.dataTransfer.setData('text/plain', orderId);
            setTimeout(() => e.target.classList.add('opacity-50'), 0);
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
            draggedOrderId = null;
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            const target = e.currentTarget;
            if (target && target.classList.contains('status-column')) {
                 target.classList.add('border-4', 'border-dashed', 'border-indigo-400', 'bg-indigo-50');
            }
        }
        
        function handleDragLeave(e) {
            const target = e.currentTarget;
            if (target) {
                target.classList.remove('border-4', 'border-dashed', 'border-indigo-400', 'bg-indigo-50');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            
            const target = e.currentTarget;
            if (target) {
                target.classList.remove('border-4', 'border-dashed', 'border-indigo-400', 'bg-indigo-50');
            }

            const orderId = e.dataTransfer.getData('text/plain');
            const newStatus = target.getAttribute('data-status');

            if (orderId && newStatus) {
                await updateOrderStatus(orderId, newStatus);
            }
        }
        
        // --- CSV Export Functions ---

        const CSV_HEADERS = [
            "Order ID", "Status", "Customer Name", "Phone Number", 
            "Shipping Address",                       
            "Alternative Phone number and land mark", 
            "City", "State", "Pincode", 
            "Order Details / Items", "Comments / Notes", "Date Submitted"
        ];

        function escapeCSV(value) {
            if (value === null || value === undefined) return "";
            let str = String(value);
            // Remove newlines and quotes, and wrap in quotes if necessary
            str = str.replace(/"/g, '""').replace(/\n/g, ' ');
            if (str.includes(',') || str.includes('"') || str.includes(' ')) {
                return `"${str}"`;
            }
            return str;
        }

        window.downloadOrdersAsCSV = (statusFilter) => {
            // Check for offline mode before downloading
            if (IS_OFFLINE_MODE) {
                showModal("Feature Disabled", "Order download is disabled in offline mode.");
                return;
            }
            
            let ordersToExport = currentKanbanOrders;

            if (statusFilter && statusFilter !== 'All') {
                ordersToExport = ordersToExport.filter(order => order.status === statusFilter);
            }

            if (ordersToExport.length === 0) {
                showModal("Download Error", "No orders match the selected status filter to download.");
                return;
            }

            let csvContent = CSV_HEADERS.join(',') + '\n';

            ordersToExport.forEach(order => {
                // Construct row based on the required CSV_HEADERS order
                const row = [
                    order.id,
                    STATUS_LABELS[order.status],
                    escapeCSV(order.customerName),
                    escapeCSV(order.phone),
                    escapeCSV(order.address),        
                    escapeCSV(order.altPhone || ''), 
                    escapeCSV(order.city),
                    escapeCSV(order.state),
                    escapeCSV(order.pincode),
                    escapeCSV(order.orderDetails),
                    escapeCSV(order.comments || ''),
                    order.createdAt ? new Date(order.createdAt.toMillis()).toLocaleString() : ''
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            const filename = statusFilter && statusFilter !== 'All' ? 
                `Orders_${statusFilter}_${new Date().toISOString().slice(0, 10)}.csv` : 
                `All_Orders_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        window.downloadOrders = () => {
            const statusSelect = document.getElementById('status-select');
            const selectedStatus = statusSelect.value;
            window.downloadOrdersAsCSV(selectedStatus);
        };
        
        function populateStatusSelect() {
            const statusSelect = document.getElementById('status-select');
            
            while (statusSelect.options.length > 1) {
                statusSelect.remove(1);
            }

            KANBAN_STATUSES.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = STATUS_LABELS[status];
                statusSelect.appendChild(option);
            });
        }


        // --- Dashboard Real-time Management ---

        function listenForOrders() {
            if (IS_OFFLINE_MODE) {
                console.error("Cannot listen to orders. Offline mode active.");
                return;
            }
            if (!db || !ordersCollectionRef) {
                console.error("Database or collection reference not ready.");
                return;
            }

            const q = query(ordersCollectionRef);
            
            onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                const initialOrders = orders.filter(o => o.status === INITIAL_STATUS);
                const kanbanOrders = orders.filter(o => o.status !== INITIAL_STATUS);
                
                currentKanbanOrders = kanbanOrders; 
                
                renderInitialReviewBoard(initialOrders);
                renderKanbanBoard(kanbanOrders);
            }, (error) => {
                console.error("Error listening to orders:", error);
                showModal("Error", "Could not load real-time order data. Check Firestore Security Rules.");
            });
        }
        
        // Renders the dedicated 'New Submission' page
        function renderInitialReviewBoard(orders) {
            initialOrdersList.innerHTML = ''; // Clear list
            
            if (orders.length === 0) {
                initialEmptyMessage.classList.remove('hidden');
                initialCountSpan.classList.add('hidden');
            } else {
                initialEmptyMessage.classList.add('hidden');
                initialCountSpan.classList.remove('hidden');
                initialCountSpan.textContent = orders.length;

                orders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).forEach(order => {
                    const orderCard = createOrderCard(order);
                    orderCard.classList.remove('border-indigo-500');
                    orderCard.classList.add('border-red-500');
                    initialOrdersList.appendChild(orderCard);
                });
            }
        }

        // Renders the main Kanban board
        function renderKanbanBoard(orders) {
            const groupedOrders = orders.reduce((acc, order) => {
                const status = order.status;
                if (!acc[status]) acc[status] = [];
                acc[status].push(order);
                return acc;
            }, {});

            ordersKanban.innerHTML = ''; // Clear board

            KANBAN_STATUSES.forEach(status => {
                const column = document.createElement('div');
                column.className = 'flex flex-col rounded-xl bg-white shadow-xl p-4';
                
                // Column Header
                const header = document.createElement('h3');
                const orderCount = (groupedOrders[status] || []).length;
                header.className = `text-lg font-semibold mb-4 p-2 rounded-lg ${STATUS_COLORS[status]}`;
                header.textContent = `${STATUS_LABELS[status]} (${orderCount})`;
                column.appendChild(header);

                // Column Body (Orders List)
                const ordersList = document.createElement('div');
                ordersList.id = `column-${status}`;
                ordersList.className = 'space-y-4 status-column pr-2 min-h-[100px] transition duration-200'; 
                
                // --- ADD DROP TARGET PROPERTIES ---
                ordersList.setAttribute('data-status', status);
                ordersList.ondragover = handleDragOver;
                ordersList.ondragenter = (e) => e.preventDefault(); 
                ordersList.ondragleave = handleDragLeave;
                ordersList.ondrop = handleDrop;
                
                (groupedOrders[status] || []).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).forEach(order => {
                    const orderCard = createOrderCard(order);
                    ordersList.appendChild(orderCard);
                });

                column.appendChild(ordersList);
                ordersKanban.appendChild(column);
            });
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            // Disable drag if offline, otherwise enable
            if (!IS_OFFLINE_MODE) {
                card.setAttribute('draggable', 'true');
                card.ondragstart = (e) => handleDragStart(e, order.id);
                card.ondragend = handleDragEnd;
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-md border-t-4 border-indigo-500 hover:shadow-lg transition duration-200 cursor-grab';
            } else {
                card.className = 'bg-gray-100 p-4 rounded-lg shadow-inner border-t-4 border-gray-400 text-gray-500 cursor-default';
            }
            
            
            // Order ID (for manager reference)
            const idSpan = document.createElement('span');
            idSpan.className = 'text-xs font-mono text-gray-500 block mb-1';
            idSpan.textContent = `ID: ${order.id.substring(0, 8)}...`;
            card.appendChild(idSpan);
            
            // Customer Name
            const name = document.createElement('p');
            name.className = 'text-base font-bold text-gray-800';
            name.textContent = order.customerName;
            card.appendChild(name);

            // Order Details 
            const details = document.createElement('p');
            details.className = 'text-sm text-gray-600 mt-1 whitespace-pre-wrap';
            
            let addressSummary = order.address;
            let altPhoneAndLandmark = order.altPhone || 'N/A';
            
            details.textContent = `Items: ${order.orderDetails}\nAddress: ${addressSummary}\nAlt Phone/Landmark: ${altPhoneAndLandmark}`;
            card.appendChild(details);

            // Time submitted
            if (order.createdAt) {
                const date = new Date(order.createdAt.toMillis());
                const time = document.createElement('p');
                time.className = 'text-xs text-gray-400 mt-2';
                time.textContent = `Submitted: ${date.toLocaleString()}`;
                card.appendChild(time);
            }

            // --- GEMINI FEATURE BUTTON ---
            const draftButton = document.createElement('button');
            draftButton.className = 'mt-3 w-full py-2 text-sm font-semibold rounded-lg text-white bg-pink-500 hover:bg-pink-600 transition duration-150 shadow-md';
            
            // Disable the button if the API key is not set (which it shouldn't be, for safety)
            if (IS_OFFLINE_MODE || !apiKey || apiKey === "") {
                draftButton.textContent = 'Draft (Disabled)';
                draftButton.disabled = true;
                draftButton.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                draftButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            } else {
                draftButton.textContent = 'Draft Customer Message ‚ú®';
                draftButton.onclick = () => draftCustomerMessage(order);
            }
            card.appendChild(draftButton);

            // Status Change Button (Kept as a fallback/alternative)
            const allStatuses = [INITIAL_STATUS, ...KANBAN_STATUSES];
            const currentStatusIndex = allStatuses.indexOf(order.status);
            const nextStatusIndex = currentStatusIndex + 1;
            const nextStatus = allStatuses[nextStatusIndex];

            if (nextStatus) {
                const nextLabel = STATUS_LABELS[nextStatus];
                
                const button = document.createElement('button');
                button.className = 'mt-2 w-full py-2 text-sm font-semibold rounded-lg text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 shadow-md';
                button.textContent = `‚Üí Move to ${nextLabel}`;
                
                if (IS_OFFLINE_MODE) {
                    button.disabled = true;
                    button.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                    button.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    button.onclick = () => updateOrderStatus(order.id, nextStatus);
                }
                card.appendChild(button);
            } else {
                const doneMessage = document.createElement('p');
                doneMessage.className = 'mt-2 w-full py-2 text-sm text-center font-semibold rounded-lg bg-green-500 text-white';
                doneMessage.textContent = 'Order Complete!';
                card.appendChild(doneMessage);
            }

            return card;
        }

        async function updateOrderStatus(orderId, newStatus) {
            if (IS_OFFLINE_MODE) {
                showModal("Access Denied", "Status updates are disabled in offline mode.");
                return;
            }

            if (!db) {
                showModal("Error", "Database connection not established.");
                return;
            }
            if (!currentUserId || currentUserId === 'anonymous') {
                showModal("Access Denied", "You must be logged in as the store manager to update order status.");
                return;
            }

            const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);

            try {
                await updateDoc(orderRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });
                console.log(`Order ${orderId} status updated to ${newStatus}`);
            } catch (error) {
                console.error("Error updating document: ", error);
                showModal("Update Failed", `Could not update status to ${newStatus}. Check console for details.`);
            }
        }
    </script>
</body>
</html>

