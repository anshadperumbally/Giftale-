<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Order Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .status-column {
            max-height: 80vh;
            overflow-y: auto;
        }
        .status-column::-webkit-scrollbar {
            width: 6px;
        }
        .status-column::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .opacity-50 {
            opacity: 0.5;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow-md rounded-xl p-4 mb-6 sticky top-0 z-10">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-700 mb-4 sm:mb-0">
                    Order Manager
                </h1>
                <div class="flex space-x-2">
                    <button id="show-form-btn" class="px-4 py-2 text-sm font-medium rounded-lg transition" 
                            onclick="switchView('form')">
                        Customer Form
                    </button>
                    <button id="show-initial-review-btn" class="px-4 py-2 text-sm font-medium rounded-lg transition" 
                            onclick="switchView('initial-review')">
                        Initial Review
                        <span id="initial-count" class="ml-1 px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full hidden">0</span>
                    </button>
    _btn" class="px-4 py-2 text-sm font-medium rounded-lg transition" 
                            onclick="switchView('dashboard')">
                        Manager Dashboard
                    </button>
                </div>
            </div>
            <p id="auth-status" class="mt-2 text-xs text-gray-500"></p>
        </header>

        <div id="loading-screen" class="flex justify-center items-center h-64 text-gray-500">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading Application...
        </div>

        <section id="form-view" class="view hidden bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">New Order Submission (Updated Form)</h2>
            <form id="order-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                    <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="phone" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Shipping Address (House/Street)</label>
                    <input type="text" id="address" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="altPhone" class="block text-sm font-medium text-gray-700">Alternative Phone Number and Landmark</label>
                    <input type="text" id="altPhone" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 9876543210 near Main Market">
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="city" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">Pincode</label>
                        <input type="text" id="pincode" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                        <select id="state" required 
                                class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                            <option value="" disabled selected>-- Select State/UT --</option>
                            </select>
                    </div>
                </div>
          _details" class="block text-sm font-medium text-gray-700">Order Details / Items</label>
                    <textarea id="orderDetails" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label for="comments" class="block text-sm font-medium text-gray-700">Comments / Notes</label>
                    <textarea id="comments" rows="2" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <button type="submit" id="submit-order-btn" class="w-full bg-green-500 text-white py-3 rounded-lg shadow-md hover:bg-green-600 transition duration-150 font-semibold">
T" id="submit-order-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                s="inline">Submit Order</span>
                </button>
            </form>
            <p id="form-message" class="mt-4 text-center hidden"></p>
        </section>

        <section id="initial-review-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Initial Review: New Submissions</h2>
            <p class="text-gray-600 mb-6">These orders are awaiting initial verification and review before moving to the main pipeline. **You can drag these cards to the 'Pending' column on the Manager Dashboard.**</p>
            <div id="initial-orders-list" class="space-y-4">
                </div>
            <p id="initial-empty-message" class="text-center text-gray-500 mt-10 hidden">🎉 No new orders in the queue! Time to review the dashboard.</p>
        </section>

        <section id="dashboard-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Order Status Board</h2>
            
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-start sm:items-center bg-white p-4 rounded-xl shadow-inner mb-6">
                <label for="status-select" class="text-sm font-medium text-gray-700 whitespace-nowrap">Export Orders with Status:</label>
                <select id="status-select" class="block w-full sm:w-auto border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="All">All Kanban Orders</option>
                    </select>
                <button onclick="downloadOrders()" class="w-full sm:w-auto px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition duration-150 shadow-md flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
s="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download CSV
                </button>
    section>

        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 transition-opacity duration-300 items-center justify-center">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-95">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800 mb-3"></h3>
                <div id="modal-content" class="text-gray-600 mb-5"></div>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition hidden">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/@sanity/client@latest/dist/sanityClient.umd.js"></script>

    <script type="module">
        // Destructure sanityClient from the global window object
        const { sanityClient } = window;

        // Array containing Indian States
        const indianStatesAndUTs = [
            "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal",
            "Chandigarh (UT)", 
            "Delhi (NCT)", 
            "Jammu and Kashmir (UT)", 
            "Puducherry (UT)"
        ];

        // ====================================================================
        // START: SANITY CONFIGURATION (SECURE)
        // --------------------------------------------------------------------
        // --- MODIFICATION ---
        // This is now a SECURE, READ-ONLY client.
        // The secret 'token' has been REMOVED.
        const sanityConfig = {
            projectId: "bfm9u3cy", // <-- YOUR PROJECT ID
            dataset: "production", 
            apiVersion: '2023-05-03',
            // NO TOKEN HERE!
            useCdn: true // `true` is faster for public reads and is recommended
        };

        const client = sanityClient(sanityConfig);
        // ====================================================================
        // END: SANITY CONFIGURATION
        // ====================================================================

        let isAppReady = false;
        let currentOrders = []; 

        // --- STATUS CONSTANTS (Unchanged) ---
        const INITIAL_STATUS = 'FormFilled';
        const KANBAN_STATUSES = ['Pending', 'ToDo', 'Processing', 'Dispatched'];
        const STATUS_COLORS = {
            [INITIAL_STATUS]: 'bg-red-100 text-red-800',
            'Pending': 'bg-yellow-100 text-yellow-800',
            'ToDo': 'bg-indigo-100 text-indigo-800',
            'Processing': 'bg-blue-100 text-blue-800',
            'Dispatched': 'bg-green-100 text-green-800',
        };
        const STATUS_LABELS = {
            [INITIAL_STATUS]: 'New Submission',
            'Pending': 'Pending',
            'ToDo': 'TO-DO',
            'Processing': 'Done',
            'Dispatched': 'Shipped/Dispatched',
        };

        // --- (Gemini API functions are unchanged, but remember the security warning!) ---
        const apiKey = ""; // ⚠️ DANGER: Still insecure. Move to a backend function!
        // ... (all Gemini helper functions like showModal, generateGeminiContent, etc.) ...
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const formView = document.getElementById('form-view');
        const initialReviewView = document.getElementById('initial-review-view');
        const dashboardView = document.getElementById('dashboard-view');
        const orderForm = document.getElementById('order-form');
        const formMessage = document.getElementById('form-message');
        const ordersKanban = document.getElementById('orders-kanban');
        const initialOrdersList = document.getElementById('initial-orders-list');
        const initialEmptyMessage = document.getElementById('initial-empty-message');
        const authStatusP = document.getElementById('auth-status');
        const showFormBtn = document.getElementById('show-form-btn');
        const showInitialReviewBtn = document.getElementById('show-initial-review-btn');
        const initialCountSpan = document.getElementById('initial-count');
        const showDashboardBtn = document.getElementById('show-dashboard-btn');
        const submitBtn = document.getElementById('submit-order-btn');
        const submitBtnSpinner = document.getElementById('submit-order-spinner');
        const submitBtnText = document.getElementById('submit-order-text');


        // --- Utility Functions (showModal, showDraftModal, etc. are unchanged) ---
        // ... (Keep all your modal functions here) ...
        function showModal(title, content, type = 'info') {
             const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = `<p class="text-gray-600 mb-5">${content}</p>`; 
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            confirmBtn.textContent = 'OK';
            confirmBtn.onclick = () => { modal.classList.add('hidden'); };
            cancelBtn.classList.add('hidden');
            
            modal.classList.remove('hidden');
            modal.style.opacity = '0';
            setTimeout(() => { modal.style.opacity = '1'; modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }
        
        // ... (Keep other utility/Gemini functions) ...


        // --- Sanity Initialization Logic ---
        async function initializeAppWithSanity() {
            authStatusP.textContent = 'Sanity Connected (Read-Only)'; // Updated status
            isAppReady = true;
            loadingScreen.classList.add('hidden');

            populateStateDropdown();
            populateStatusSelect();

            await fetchAndRenderOrders();
            listenForSanityOrders();

            switchView('initial-review');
        }

        // --- Dropdown Population Function (Unchanged) ---
        function populateStateDropdown() {
             const dropdown = document.getElementById('state');
            if (dropdown) {
                dropdown.innerHTML = '<option value="" disabled selected>-- Select State/UT --</option>';
                indianStatesAndUTs.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    dropdown.appendChild(option);
                });
            }
        }

        // --- View Switching (Unchanged) ---
        function resetButtons() { /* ... keep existing code ... */ }
        window.switchView = (viewName) => {
             if (!isAppReady) return; 
            
            const allViews = document.querySelectorAll('.view');
            allViews.forEach(v => v.classList.add('hidden'));
            [showFormBtn, showInitialReviewBtn, showDashboardBtn].forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });

            if (viewName === 'form') {
                formView.classList.remove('hidden');
                showFormBtn.classList.add('bg-indigo-600', 'text-white');
            } else if (viewName === 'initial-review') {
                initialReviewView.classList.remove('hidden');
                showInitialReviewBtn.classList.add('bg-indigo-600', 'text-white');
            } else if (viewName === 'dashboard') {
                dashboardView.classList.remove('hidden');
                showDashboardBtn.classList.add('bg-indigo-600', 'text-white');
            }
        };

        // --- MODIFICATION: Secure Order Form Submission ---
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!client) {
                showModal("Error", "Sanity client not initialized.");
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtnSpinner.classList.remove('hidden');
            submitBtnText.classList.add('hidden');

            // Capture form fields
            const formData = {
                customerName: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                altPhone: document.getElementById('altPhone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                pincode: document.getElementById('pincode').value,
                state: document.getElementById('state').value,
                orderDetails: document.getElementById('orderDetails').value,
                comments: document.getElementById('comments').value,
                status: INITIAL_STATUS
            };

            try {
                // Securely send data to the new backend function
                const response = await fetch('/api/submit-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Submission failed');
                }

                const result = await response.json();
                console.log('Order submitted successfully:', result.orderId);

                formMessage.textContent = 'Order submitted successfully! We will contact you soon.';
                formMessage.classList.remove('hidden', 'text-red-600');
                formMessage.classList.add('text-green-600');
                orderForm.reset();
                populateStateDropdown();
                setTimeout(() => formMessage.classList.add('hidden'), 5000);

            } catch (error) {
                console.error("Error submitting order: ", error);
                showModal("Submission Failed", `There was an error: ${error.message}. Please try again.`);
                formMessage.textContent = 'Submission failed. Please try again.';
                formMessage.classList.remove('hidden', 'text-green-600');
                formMessage.classList.add('text-red-600');
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                submitBtnSpinner.classList.add('hidden');
                submitBtnText.classList.remove('hidden');
            }
        });

        // --- Drag and Drop Handlers (Unchanged) ---
        let draggedOrderId = null;
        function handleDragStart(e, orderId) {
            draggedOrderId = orderId;
            e.dataTransfer.setData('text/plain', orderId);
            setTimeout(() => e.target.classList.add('opacity-50'), 0);
        }
        function handleDragEnd(e) { /* ... keep existing code ... */ }
        function handleDragOver(e) { /* ... keep existing code ... */ }
        function handleDragLeave(e) { /* ... keep existing code ... */ }

        async function handleDrop(e) {
            e.preventDefault();
            
            const target = e.currentTarget;
            if (target) {
                target.classList.remove('border-4', 'border-dashed', 'border-indigo-400', 'bg-indigo-50');
            }

            const orderId = e.dataTransfer.getData('text/plain');
            const newStatus = target.getAttribute('data-status');

            if (orderId && newStatus) {
                // --- MODIFICATION ---
                // Call the new secure update function
                await updateSanityOrderStatus(orderId, newStatus);
            }
        }


        // --- CSV Export Functions (Unchanged) ---
        const CSV_HEADERS = [
            "Order ID", "Status", "Customer Name", "Phone Number", 
            "Shipping Address", 
            "Alternative Phone number and land mark", 
            "City", "State", "Pincode", 
            "Order Details / Items", "Comments / Notes", "Date Submitted"
        ];
        function escapeCSV(value) { /* ... keep existing code ... */ }
        window.downloadOrdersAsCSV = (statusFilter) => {
             let ordersToExport = currentOrders;

             if (statusFilter === 'All') {
                ordersToExport = ordersToExport.filter(order => order.status !== INITIAL_STATUS);
             } else if (statusFilter) {
                ordersToExport = ordersToExport.filter(order => order.status === statusFilter);
             }

             if (ordersToExport.length === 0) {
                 showModal("Download Error", "No orders match the selected status filter to download.");
                 return;
             }
             
             let csvContent = CSV_HEADERS.join(',') + '\n';
             ordersToExport.forEach(order => {
                const row = [
                    order.id,
                    STATUS_LABELS[order.status],
                    escapeCSV(order.customerName),
                    escapeCSV(order.phone),
                    escapeCSV(order.address),
                    escapeCSV(order.altPhone || ''),
                    escapeCSV(order.city),
                    escapeCSV(order.state),
                    escapeCSV(order.pincode),
                    escapeCSV(order.orderDetails),
                    escapeCSV(order.comments || ''),
                    order.createdAt ? new Date(order.createdAt).toLocaleString() : ''
                ];
                csvContent += row.join(',') + '\n';
             });
             
             // ... blob creation and download logic ...
             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.setAttribute('href', url);
             const filename = statusFilter && statusFilter !== 'All' ? 
                 `Orders_${statusFilter}_${new Date().toISOString().slice(0, 10)}.csv` : 
                 `All_Orders_${new Date().toISOString().slice(0, 10)}.csv`;
             link.setAttribute('download', filename);
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        };
        window.downloadOrders = () => {
            const statusSelect = document.getElementById('status-select');
            window.downloadOrdersAsCSV(statusSelect.value);
        };
        function populateStatusSelect() { /* ... keep existing code ... */ }


        // --- Real-time Management (Unchanged logic, just uses read-only client) ---
        function mapSanityDocToOrder(doc) {
            return {
                id: doc._id,
                createdAt: doc._createdAt,
                updatedAt: doc._updatedAt,
                ...doc
            };
        }

        const sanityOrderQuery = '*[_type == "order"] | order(_createdAt desc)';
        let sanityListenerSubscription = null;

        async function fetchAndRenderOrders() {
            try {
                const sanityDocs = await client.fetch(sanityOrderQuery);
                currentOrders = sanityDocs.map(mapSanityDocToOrder);
                renderAllBoards(currentOrders);
            } catch (error) {
                console.error("Error fetching initial orders:", error);
                showModal("Error", "Could not load order data. Check Sanity CORS origins.");
            }
        }

        function listenForSanityOrders() {
            if (sanityListenerSubscription) {
                sanityListenerSubscription.unsubscribe();
            }
            sanityListenerSubscription = client.listen(sanityOrderQuery, {}, { includeResult: false, visibility: 'query' })
                .subscribe(update => {
                    console.log('Sanity update received:', update);
                    // On any change, refetch all data.
                    // This is simple and effective.
                    fetchAndRenderOrders();
                });
        }

        function renderAllBoards(orders) {
            const initialOrders = orders.filter(o => o.status === INITIAL_STATUS);
            const kanbanOrders = orders.filter(o => o.status !== INITIAL_STATUS);
            renderInitialReviewBoard(initialOrders);
            renderKanbanBoard(kanbanOrders);
        }

        function renderInitialReviewBoard(orders) { /* ... keep existing code ... */ }
        function renderKanbanBoard(orders) { /* ... keep existing code ... */ }
        
        function createOrderCard(order) {
            const card = document.createElement('div');
            // All users can drag, but the update function will handle security
            card.setAttribute('draggable', 'true');
            card.ondragstart = (e) => handleDragStart(e, order.id);
            card.ondragend = handleDragEnd;
            card.className = 'bg-gray-50 p-4 rounded-lg shadow-md border-t-4 border-indigo-500 hover:shadow-lg transition duration-200 cursor-grab';

            // ... (Order ID, Name, Details, Time ... all unchanged) ...
            const idSpan = document.createElement('span');
            idSpan.className = 'text-xs font-mono text-gray-500 block mb-1';
            idSpan.textContent = `ID: ${order.id.substring(0, 8)}...`;
            card.appendChild(idSpan);
            
            const name = document.createElement('p');
            name.className = 'text-base font-bold text-gray-800';
            name.textContent = order.customerName;
            card.appendChild(name);

            const details = document.createElement('p');
            details.className = 'text-sm text-gray-600 mt-1 whitespace-pre-wrap';
            let addressSummary = order.address;
            let altPhoneAndLandmark = order.altPhone || 'N/A';
            details.textContent = `Items: ${order.orderDetails}\nAddress: ${addressSummary}\nAlt Phone/Landmark: ${altPhoneAndLandmark}`;
            card.appendChild(details);

            if (order.createdAt) {
                const date = new Date(order.createdAt);
                const time = document.createElement('p');
                time.className = 'text-xs text-gray-400 mt-2';
                time.textContent = `Submitted: ${date.toLocaleString()}`;
                card.appendChild(time);
            }
            
            // ... (Gemini button code is unchanged) ...
            
            // Status Change Button
            const allStatuses = [INITIAL_STATUS, ...KANBAN_STATUSES];
            const currentStatusIndex = allStatuses.indexOf(order.status);
            const nextStatusIndex = currentStatusIndex + 1;
            const nextStatus = allStatuses[nextStatusIndex];

            if (nextStatus) {
                const nextLabel = STATUS_LABELS[nextStatus];
                const button = document.createElement('button');
                button.className = 'mt-2 w-full py-2 text-sm font-semibold rounded-lg text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 shadow-md';
                button.textContent = `→ Move to ${nextLabel}`;
                
                // --- MODIFICATION ---
                // Call the new secure update function
                button.onclick = () => updateSanityOrderStatus(order.id, nextStatus);
                card.appendChild(button);
            } else {
                const doneMessage = document.createElement('p');
                doneMessage.className = 'mt-2 w-full py-2 text-sm text-center font-semibold rounded-lg bg-green-500 text-white';
                doneMessage.textContent = 'Order Complete!';
                card.appendChild(doneMessage);
            }

            return card;
        }

        // --- MODIFICATION: Secure Update Order Status ---
        async function updateSanityOrderStatus(orderId, newStatus) {
            // Note: This function is now optimistic. It sends the request to the
            // backend, and the real-time listener will catch the change.
            // We could add loading spinners to the card, but this is simpler.

            try {
                // Securely send the update request to the new backend function
                const response = await fetch('/api/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId, newStatus: newStatus })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Failed to update status');
                }

                console.log(`Update request sent for ${orderId} to ${newStatus}`);
                // The real-time listener will handle the UI update
                
            } catch (error) {
                console.error("Error updating status: ", error);
                showModal("Update Failed", `Could not update status. Error: ${error.message}. You may need a manager token for this.`);
            }
        }

        // --- Start the app ---
        initializeAppWithSanity();

    </script>
</body>
</html>
